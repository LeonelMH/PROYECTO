<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panchito 360p</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    .botones {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 1rem;
    }
    .botones button {
      font-size: 1rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    .fila-principal {
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      gap: 20px;
      margin-bottom: 1rem;
    }
    .contenedor-camara {
      position: relative;
      width: 600px;
      height: 500px;
      border: 1px solid #ccc;
    }
    .contenedor-camara video,
    .contenedor-camara canvas {
      position: absolute;
      top: 0;
      left: 0;
    }
    .paneles-voz {
      display: flex;
      flex-direction: row;
      gap: 10px;
      width: 400px;
      color: #000000;
    }
    .panel-bloque {
      display: flex;
      flex-direction: column;
      width: 250px;
      margin-bottom: 20px;
      margin-right: 20px;
    }
    .panel {
      background-color: white;
      border: 1px solid #ccc;
      padding: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      width: 250px;;
      height: 360px;
      overflow-y: auto;
    }

    .panel h3 {
      margin: 0 0 8px 0;
      font-size: 1rem;
    }

    .panel .scroll {
      flex: 1;
      overflow-y: auto;
    }
    .panel-titulo {
      margin: 0 0 4px 0;
      font-size: 1rem;
      font-weight: bold;
      color: #ffffff;
      text-align: center;
      
    }

    .resaltado-rojo {
      background-color: #ffe0e0;
      border-left: 4px solid red;
      padding-left: 8px;
    }
    .resaltado-verde {
      background-color: #e0ffe0;
      border-left: 4px solid green;
      padding-left: 8px;
    }
    /* .grafica-container {
      display: flex;
      justify-content: center;
      margin-top: 1rem;
      max-height: 320px;
      clear: both;
    }

    canvas#grafica {
      display: block;
      position: static;
      width: 600px;
      height: 300px; 
      max-width: 600px;
      background-color: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    } */
    #earRegistro {
  font-family: monospace;
  font-size: 0.9rem;
    }
    body {
  background-color: #0c1a2b; /* azul marino profundo */
  font-family: 'Segoe UI', Tahoma, sans-serif;
  color: #ffffff; /* gris claro */
  padding: 20px;
}
.frases-horizontal {
  display: flex;
  justify-content: space-between;
  gap: 40px;
  margin-top: 30px;
}

.bloque-frases {
  flex: 1;
  background-color: #ffffff;
  color: #000000;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 0 5px rgba(0,0,0,0.2);
}

.titulo-rojo {
  color: red;
  margin-bottom: 10px;
}

ul {
  list-style-type: disc;
  padding-left: 20px;
  margin-bottom: 10px;
}

input {
  width: 80%;
  padding: 6px;
  margin-top: 5px;
}

button {
  padding: 6px 10px;
  margin-left: 5px;
  cursor: pointer;
}
#listaCansancio, #listaRecuperacion {
  max-height: 250px; /* ajusta seg√∫n tu dise√±o */
  overflow-y: auto;
  background-color: #f9f9f9;
  color: #000000;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  margin-bottom: 10px;
}


  </style>
</head>
<body>
  <div class="botones">
    
    <button onclick="toggleCaptura()">Iniciar / Detener Captura</button>
    <button onclick="limpiar()">Limpiar Registros</button>
    <button onclick="activarCamara()">Activar C√°mara</button>

<script>

</script>
  </div>

  <!-- <audio id="alertaSonido" src="/static/Estoy cansado jefe.mp3" preload="auto"></audio> -->
  <audio id="alertaSonido" src="/static/alertav1.mp3" preload="auto"></audio>
  <audio id="alertaRecuperacionVoz" src="/static/recuperacion.mp3" preload="auto"></audio>

<div class="fila-principal">
  <!-- C√°mara a la izquierda -->
  <div class="contenedor-camara">
    <video id="video" autoplay muted playsinline width="600" height="500"></video>
    <canvas id="canvas" width="600" height="500"></canvas>
  </div>

  <!-- Paneles a la derecha -->
  <div class="paneles-voz">
    <div class="panel-bloque">
      <h3 class="panel-titulo">Detecci√≥n de voz</h3>
      <div class="panel" id="deteccion">
        <div class="scroll" id="voz"></div>
      </div>
    </div>

    <div class="panel-bloque">
      <h3 class="panel-titulo">Log de voz en tiempo real</h3>
      <div class="panel" id="registro">
        <div class="scroll" id="log"></div>
      </div>
    </div>

    <div class="panel-bloque">
      <h3 class="panel-titulo">Relaci√≥n de aspecto del ojo</h3>
      <div class="panel" id="earLog">
        <div id="earRegistro"></div>
      </div>
    </div>
  </div>
</div>


<div class="frases-horizontal">
  <div class="bloque-frases">
    <h3 class="titulo-rojo">Frases Cansancio</h3>
    <ul id="listaCansancio"></ul>
  </div>

  <div class="bloque-frases">
    <h3 class="titulo-rojo">Frases Recuperaci√≥n</h3>
    <ul id="listaRecuperacion"></ul>
  </div>
</div>
  


<!-- <h3 style="text-align:center;">Gr√°fica de Intenciones</h3>
<div class="grafica-container"></div>
<canvas id="grafica" width="600" height="300"></canvas> -->
</div>


  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh_connections.js"></script>

  <script>


let frases_cansancio = ["estoy cansado", "necesito descansar", "no puedo m√°s", "no puedo mas",
  "me siento fatigado", "estoy agotado", "me siento exhausto", "ya no rindo",
  "me cuesta concentrarme", "tengo sue√±o", "me siento d√©bil", "me siento debil",
  "estoy adormilado", "no tengo energ√≠a", "no tengo energia", "me siento lento",
  "estoy abrumado", "me siento saturado", "necesito una pausa", "estoy quemado",
  "me siento sin fuerzas", "no estoy al cien", "no estoy al 100", "me siento distra√≠do"];

let frases_recuperacion = ["ya estoy bien", "me siento mejor", "ya descans√©", "ya descanse",
  "estoy despierto", "me siento renovado", "estoy listo", "me siento con energ√≠a",
  "ya me recuper√©", "ya me recupere", "me siento enfocado", "estoy al cien",
  "ya estoy al 100", "ya estoy activo", "me siento despejado", "estoy alerta",
  "ya estoy concentrado", "me siento motivado", "ya estoy de vuelta", "me siento presente",
  "estoy en forma", "ya pas√≥ el cansancio", "me siento estable"];

function mostrarFrases() {
  const listaC = document.getElementById("listaCansancio");
  const listaR = document.getElementById("listaRecuperacion");
  listaC.innerHTML = '';
  listaR.innerHTML = '';

  frases_cansancio.forEach((frase, index) => {
    const li = document.createElement("li");
    li.innerHTML = `<strong>${index + 1}.</strong> ${frase}`;
    listaC.appendChild(li);
  });

  frases_recuperacion.forEach((frase, index) => {
    const li = document.createElement("li");
    li.innerHTML = `<strong>${index + 1}.</strong> ${frase}`;
    listaR.appendChild(li);
  });
}

mostrarFrases();












    let capturaActiva = false;
    let scrollManual = { voz: false, log: false, earRegistro: false };

    function toggleCaptura() {
      capturaActiva = !capturaActiva;
      fetch('/toggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ activo: capturaActiva })
      });
    }

    function limpiar() {
      fetch('/limpiar', { method: 'POST' });
      document.getElementById('voz').innerHTML = '';
      document.getElementById('log').innerHTML = '';
      document.getElementById('earRegistro').innerHTML = ''; 
    }

    function detectScroll(id) {
      const el = document.getElementById(id);
      el.addEventListener('scroll', () => {
        const atBottom = el.scrollHeight - el.scrollTop <= el.clientHeight + 10;
        scrollManual[id] = !atBottom;
      });
    }

    detectScroll('voz');
    detectScroll('log');
    detectScroll('earRegistro');

    setInterval(() => {
      fetch('/frases')
        .then(res => res.json())
        .then(data => {
          const voz = document.getElementById('voz');
          const log = document.getElementById('log');

          voz.innerHTML = data.deteccion.map(linea => {
            if (linea.includes("üî¥ Fatiga verbal detectada.")) {
              return `<div class="resaltado-rojo">${linea}</div>`;
            } else if (linea.includes("üü¢ Recuperaci√≥n verbal detectada.")) {
              return `<div class="resaltado-verde">${linea}</div>`;
            } else {
              return `<div>${linea}</div>`;
            }
          }).join('');

          log.innerHTML = data.frases.map(frase => {
            let resaltada = frase;
            data.frases_fatiga.forEach(palabra => {
              const regex = new RegExp(`(${palabra})`, 'gi');
              resaltada = resaltada.replace(regex, `<span class="resaltado-rojo">$1</span>`);
            });
            data.frases_recuperacion.forEach(palabra => {
              const regex = new RegExp(`(${palabra})`, 'gi');
              resaltada = resaltada.replace(regex, `<span class="resaltado-verde">$1</span>`);
            });
            return `<div>${resaltada}</div>`;
          }).join('');

          if (!scrollManual.voz) voz.scrollTop = voz.scrollHeight;
          if (!scrollManual.log) log.scrollTop = log.scrollHeight;
        });
    }, 1000);


    // Elementos
const videoElement = document.getElementById('video');
const canvasElement = document.getElementById('canvas');
const canvasCtx = canvasElement.getContext('2d');
const earRegistro = document.getElementById('earRegistro');
const alertaSonido = document.getElementById('alertaSonido');
const alertaRecuperacionVoz = document.getElementById('alertaRecuperacionVoz');


let mensajeCanvas = null;
let mensajeExpira = 0;


let procesando = false;
let estadoOcularPrevio = null;
let alert_active = false;
let fatigue_detected_at = null;
let ultimoCanvasUpdate = 0;

const EAR_THRESHOLD = 0.20; //umbral de relaci√≥n de aspecto del ojo
const FATIGUE_PERCENTAGE_THRESHOLD = 0.85; //umbral de porcentaje de fatiga
const RECOVERY_THRESHOLD = 0.30;
const RECOVERY_DELAY_MS = 3000;
const INTERVALO_CANVAS_MS = 66;
const WINDOW_DURATION = 3000;
let earRecords = [];

function euclidean(p1, p2) {
  return Math.hypot(p1.x - p2.x, p1.y - p2.y);
}

const rightEyeIdx = [33, 160, 158, 133, 153, 144];
const leftEyeIdx  = [263, 387, 385, 362, 380, 373];

function computeEAR(landmarks, indices) {
  const p1 = landmarks[indices[0]];
  const p2 = landmarks[indices[1]];
  const p3 = landmarks[indices[2]];
  const p4 = landmarks[indices[3]];
  const p5 = landmarks[indices[4]];
  const p6 = landmarks[indices[5]];
  const vertical = Math.hypot(p2.x - p6.x, p2.y - p6.y) + Math.hypot(p3.x - p5.x, p3.y - p5.y);
  const horizontal = Math.hypot(p1.x - p4.x, p1.y - p4.y);
  return vertical / horizontal;
}

const faceMesh = new FaceMesh({
  locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
});

faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

faceMesh.onResults(results => {
  const timestamp = Date.now();
  const hora = new Date().toLocaleTimeString("es-MX", { hour12: false });

  if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
    const landmarks = results.multiFaceLandmarks[0];
    const rightEyeIdx = [33, 160, 158, 133, 153, 144];
    const leftEyeIdx = [263, 387, 385, 362, 380, 373];
    const rightEAR = computeEAR(landmarks, rightEyeIdx);
    const leftEAR = computeEAR(landmarks, leftEyeIdx);
    const avgEAR = (rightEAR + leftEAR) / 2;

    // Canvas update
    if (timestamp - ultimoCanvasUpdate > INTERVALO_CANVAS_MS) {
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
      if (mensajeCanvas && timestamp < mensajeExpira) {
            canvasCtx.fillStyle = mensajeCanvas.includes("FATIGA") ? "red" : "green";
            canvasCtx.font = "bold 18px Arial";
            canvasCtx.fillText(mensajeCanvas, 30, 60);
        } 
        else {
            mensajeCanvas = null; // limpiar si ya expir√≥
        }
      //drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION, { color: '#00FF00', lineWidth: 1 });
      drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION, { color: '#FF0000', lineWidth: 1 }); // Rojo
      drawLandmarks(canvasCtx, landmarks, { color: '#00FF00', lineWidth: 1, radius: 1 }); // Verde
      canvasCtx.fillStyle = "white";
      canvasCtx.font = "16px Arial";
      canvasCtx.fillText(`EAR: ${avgEAR.toFixed(3)}`, 10, 20);
      ultimoCanvasUpdate = timestamp;
      canvasCtx.restore();
    }

    // Transici√≥n ocular
    const estadoActual = avgEAR < EAR_THRESHOLD ? "cerrado" : "abierto";
    if (estadoActual !== estadoOcularPrevio) {
      const mensaje = estadoActual === "cerrado"
        ? `${hora} ‚Üí üëÅ Cierre detectado (EAR=${avgEAR.toFixed(3)})`
        : `${hora} ‚Üí üëÅ Apertura detectada (EAR=${avgEAR.toFixed(3)})`;

      earRegistro.innerHTML += `<div>${mensaje}</div>`;
      if (!scrollManual.earRegistro) {
        earRegistro.scrollTop = earRegistro.scrollHeight;
      }
      if (earRegistro.childNodes.length > 100) {
        earRegistro.removeChild(earRegistro.firstChild);
      }

      estadoOcularPrevio = estadoActual;
    }

    // Evaluaci√≥n de fatiga
    earRecords.push([timestamp, avgEAR]);
    earRecords = earRecords.filter(([t]) => timestamp - t <= WINDOW_DURATION);
    const ears = earRecords.map(([_, e]) => e);
    const lowCount = ears.filter(e => e < EAR_THRESHOLD).length;
    const fatigueRatio = ears.length ? lowCount / ears.length : 0;

    // Activar alarma si EAR est√° por debajo del umbral
if (fatigueRatio >= FATIGUE_PERCENTAGE_THRESHOLD && !alert_active) {
  canvasCtx.save();
  canvasCtx.fillStyle = "red";
  canvasCtx.font = "bold 18px Arial";
  mensajeCanvas = "üî¥ FATIGA VISUAL DETECTADA"
  mensajeExpira = timestamp + 3000;
  earRegistro.innerHTML += `<div class="resaltado-rojo">${hora} ‚Üí üëÅ FATIGA VISUAL DETECTADA (EAR=${avgEAR.toFixed(3)})</div>`;
  canvasCtx.restore();

  alertaSonido.loop = true;
  alertaSonido.play();
  alert_active = true;
  fatigue_detected_at = timestamp;
}

// Desactivar alarma si hay actividad ocular sostenida
if (alert_active) {
  const recoveryWindow = earRecords.filter(([t]) => timestamp - t <= RECOVERY_DELAY_MS);
  const highCount = recoveryWindow.filter(([_, e]) => e >= RECOVERY_THRESHOLD).length;
  const recoveryRatio = recoveryWindow.length ? highCount / recoveryWindow.length : 0;
  
  if (recoveryRatio >= 0.5) {
    canvasCtx.save();
    canvasCtx.fillStyle = "green";
    canvasCtx.font = "bold 18px Arial";
    canvasCtx.fillText("üü¢ RECUPERACI√ìN DETECTADA", 10, 30);
    mensajeCanvas = "üü¢ RECUPERACI√ìN VISUAL DETECTADA"
    mensajeExpira = timestamp + 3000; 
    earRegistro.innerHTML += `<div class="resaltado-verde">${hora} ‚Üí üëÅ RECUPERACI√ìN VISUAL DETECTADA (EAR=${avgEAR.toFixed(3)})</div>`;
    canvasCtx.restore();

    alertaSonido.loop = false;
    alertaSonido.pause();
    alertaSonido.currentTime = 0;
    alert_active = false;
    fatigue_detected_at = null;

    alertaRecuperacionVoz.pause();
    alertaRecuperacionVoz.currentTime = 0;
    alertaRecuperacionVoz.play();

  }
}
  }
});

const camera = new Camera(videoElement, {
  onFrame: async () => {
    await faceMesh.send({ image: videoElement });
  },
  width: 600,
  height: 500
  
});

let camaraActiva = false;

function activarCamara() {
  if (!camaraActiva) {
    camera.start(); // activa la c√°mara
    camaraActiva = true;
  } else {
    camera.stop(); // detiene la c√°mara
    camaraActiva = false;

    // limpia el canvas
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
  }
}


//       const ctx = document.getElementById('grafica').getContext('2d');
//       const grafica = new Chart(ctx, {
//         type: 'bar',
//         data: {
//           labels: ['Fatiga Verbal', 'Fatiga Ocular', 'Positiva', 'Contradicci√≥n', 'Solicitud', 'Recuperaci√≥n'],
//           datasets: [{
//             label: 'Intenciones Detectadas',
//             data: [0, 0, 0, 0, 0, 0],
//             backgroundColor: [
//               '#ff6666', '#cc99ff', '#66cc66', '#ffcc66', '#ff9966', '#66ffff'
//             ]
//           }]
//         },
//         options: {
//   responsive: true,
//   maintainAspectRatio: true,
//   scales: {
//     x: { grid: { display: false } },
//     y: {
//       beginAtZero: true,
//       grid: { display: false },
//       ticks: {
//         color: '#333',
//         font: { size: 12 }
//       }
//     }
//   },
//   plugins: {
//     legend: { display: false }
//   }
// }
//       });

//       function actualizarGrafica(contador) {
//         grafica.data.datasets[0].data = [
//           contador.fatiga_verbal || 0,
//           contador.fatiga_ocular || 0,
//           contador.positiva || 0,
//           contador.contradiccion || 0,
//           contador.solicitud || 0,
//           contador.recuperacion || 0
//         ];
//         grafica.update();
//       }

      setInterval(() => {
        fetch('/frases_semantico')
          .then(res => res.json())
          .then(data => {
            frases.innerHTML = data.frases.map(f => `<div>${f}</div>`).join('');
            lexico.innerHTML = data.lexico.map(l => `<div>${l}</div>`).join('');
            semantico.innerHTML = data.semantico.map(s => {
          if (s.includes("‚ö†Ô∏è")) return `<div class="resaltado-rojo">${s}</div>`;
          if (s.includes("üü¢")) return `<div class="resaltado-verde">${s}</div>`;
          if (s.includes("üü†")) return `<div class="resaltado-naranja">${s}</div>`;
          if (s.includes("üî¥") && s.includes("ocular")) return `<div class="resaltado-morado">${s}</div>`;
          if (s.includes("üî¥")) return `<div class="resaltado-rojo">${s}</div>`;
          return `<div>${s}</div>`;
        }).join('');
        actualizarGrafica(data.contador);
      });
      }, 1000);
    

      
  </script>
</body>
</html>